<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Enter the void * - Closures are prepared statements</title>
        <link rel="stylesheet" type="text/css" href="../css/bootstrap.css" />
        <link rel="stylesheet" type="text/css" href="../css/extra.css" />
        <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
        <link rel="alternate" type="application/rss+xml" title="Enter the void *" href="../rss.xml" />
        <link rel="shortcut icon" href="../favicon.ico" />
        <link href="http://fonts.googleapis.com/css?family=Merriweather:400,300" rel="stylesheet" type="text/css" />
    </head>
    <body>
        <div class="header container">
            <h1 class="maintitle">Enter the void *</h1>
               <div class="nav-hdr">
                   <ul>
                      <li><a href="../">Home</a></li>
                      <li><a href="../posts.html">All posts</a></li>
                      <li><a href="../rss.xml">Feed</a></li>
                      <li><a href="https://github.com/emillon">Github</a></li>
                      <li><a href="https://qa.debian.org/developer.php?login=me%40emillon.org">Debian</a></li>
                      <li><a href="https://twitter.com/etiennemillon">Twitter</a></li>
                   </ul>
                </div>
        </div>
        <div class="maincontainer container">
          <div class="col-md-8 col-md-offset-2">
            <h1>Closures are prepared statements</h1>

<p>by <em>Etienne Millon</em> on <strong>No date</strong></p>

<p>Tagged as: <a href="../tags/ocaml.html">ocaml</a>.</p>

<p>The other day I saw <a href="https://news.ycombinator.com/item?id=8917689">an interesting interview question</a>:</p>
<blockquote>
<p>Implement function foo which takes an integer size, and returns an array of that size where each element in that array is a function that returns the index of that function in the array.</p>
</blockquote>
<p>It is a nice question to evaluate how well a programmer understands closures.</p>
<p>Here is a possible OCaml solution<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">let</span> build_array n =</a>
<a class="sourceLine" id="cb1-2" title="2">  <span class="kw">let</span> a = <span class="dt">Array</span>.make n (<span class="kw">fun</span> () -&gt; <span class="kw">assert</span> <span class="kw">false</span>) <span class="kw">in</span></a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="kw">for</span> i = <span class="dv">0</span> <span class="kw">to</span> n - <span class="dv">1</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-4" title="4">    <span class="kw">let</span> f () =</a>
<a class="sourceLine" id="cb1-5" title="5">      i</a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="kw">in</span></a>
<a class="sourceLine" id="cb1-7" title="7">    a.(i) &lt;- f</a>
<a class="sourceLine" id="cb1-8" title="8">  <span class="kw">done</span>;</a>
<a class="sourceLine" id="cb1-9" title="9">  a</a></code></pre></div>
<p>The initialization creates an array of the correct size, whose elements are all initialized to <code>fun () -&gt; assert false</code>. That is because <code>Array.make</code> requires an initializer of the correct type, but that is not too important here.</p>
<p>Then, in the for loop, we construct a function that returns the loop index, and assign it to the corresponding element in the array.</p>
<p>This is surprising because it seems that to work this needs to create code at run-time.</p>
<p>But actually, <code>f</code> can be compiled only once, without knowing what <code>i</code> will be.</p>
<p>The expression <code>fun () -&gt; i</code> contains a free variable, <code>i</code>. Its value can not be known at compile time. So, to compile this function, every occurrence of <code>i</code> inside has to be replaced by a marker saying “the value of <code>i</code>”.</p>
<p>During the execution of the loop, at the <code>let f</code>, an object is created that combines the code of <code>f</code> (with the wildcard value) with the value of <code>i</code>. This is a <em>closure</em>.</p>
<p>The code is roughly compiled like this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">let</span> build_array n =</a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="kw">let</span> a = <span class="dt">Array</span>.make n (<span class="kw">fun</span> () -&gt; <span class="kw">assert</span> <span class="kw">false</span>) <span class="kw">in</span></a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="kw">for</span> i = <span class="dv">0</span> <span class="kw">to</span> n - <span class="dv">1</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-4" title="4">    <span class="kw">let</span> f_code () =</a>
<a class="sourceLine" id="cb2-5" title="5">      closure_param <span class="dv">0</span></a>
<a class="sourceLine" id="cb2-6" title="6">    <span class="kw">in</span></a>
<a class="sourceLine" id="cb2-7" title="7">    <span class="kw">let</span> f = build_closure f_code [|i|] <span class="kw">in</span></a>
<a class="sourceLine" id="cb2-8" title="8">    a.(i) &lt;- f</a>
<a class="sourceLine" id="cb2-9" title="9">  <span class="kw">done</span>;</a>
<a class="sourceLine" id="cb2-10" title="10">  a</a></code></pre></div>
<p>This relies on the runtime having a function that can interpret calls to <code>closure_param</code> and replace them with the actual captured value. Note that at runtime, names are not necessary: it is enough to refer to captured values by number.</p>
<p>Here, a total of <code>n</code> closures are created. The code part is shared by all, and the values captured are all different.</p>
<pre><code>+---------+---------+---------+---------+---------+
|    0    |    1    |    2    |    3    |    4    |     Array (a)
+---------+---------+---------+---------+---------+
     |         |         |         |         |
     v         v         v         v         v
 +---+---+ +---+---+ +---+---+ +---+---+ +---+---+
 |   |   | |   |   | |   |   | |   |   | |   |   |      Closures (f)
 +---+---+ +---+---+ +---+---+ +---+---+ +---+---+
   |   |     |   |     |   |     |   |     |   |
   |   v     |   v     |   v     |   v     |   v
   | +---+   | +---+   | +---+   | +---+   | +---+
   | | 0 |   | | 1 |   | | 2 |   | | 3 |   | | 4 |      Captured values (i)
   | +---+   | +---+   | +---+   | +---+   | +---+
   |         |         |         |         |
   v         v         v         v         v
+-------------------------------------------------+
|                      Code                       |     Shared code (f_code)
+-------------------------------------------------+</code></pre>
<p>This technique makes it possible to have compile-time “holes” in functions, without having to pass them explicitely.</p>
<p>Surprisingly, it exists in another field: database systems. Most databases have a feature called prepared statements, which look like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> users <span class="kw">WHERE</span> name <span class="op">=</span> ? <span class="kw">AND</span> active <span class="op">=</span> <span class="dv">1</span></a></code></pre></div>
<p>They contain holes, marked with <code>?</code>. To use them, it necessary to pass both the code itself (with holes) and parameters will be replaced with. The database server will then use the parameters when it sees <code>?</code> wildcards.</p>
<p>They have two advantages. The first one is that the code part can be reused with different parameters, without parsing the query again. The second one is that it prevents SQL injection vulnerabilities, since no erroneous query can be built.</p>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>A more idiomatic verion would use <code>Array.init</code>, but then it does not use closures.<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</section>



          </div>
        </div>
        <div class="footer container">
            <p>
                I love feedback! Feel free to catch me on twitter
                (<a href="https://twitter.com/etiennemillon">@etiennemillon</a>)
                or drop me mail (me AT emillon DOT org).
            </p>
        </div>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-51676253-1', 'emillon.org');
          ga('send', 'pageview');

        </script>
    </body>
</html>
