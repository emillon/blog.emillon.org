<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Enter the void * - The size of types</title>
        <link rel="stylesheet" type="text/css" href="../css/bootstrap.css" />
        <link rel="stylesheet" type="text/css" href="../css/extra.css" />
        <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
        <link rel="alternate" type="application/rss+xml" title="Enter the void *" href="../rss.xml" />
        <link rel="shortcut icon" href="../favicon.ico" />
        <link href="http://fonts.googleapis.com/css?family=Merriweather:400,300" rel="stylesheet" type="text/css" />
    </head>
    <body>
        <div class="header container">
            <h1 class="maintitle">Enter the void *</h1>
               <div class="nav-hdr">
                   <ul>
                      <li><a href="../">Home</a></li>
                      <li><a href="../posts.html">All posts</a></li>
                      <li><a href="../rss.xml">Feed</a></li>
                      <li><a href="https://github.com/emillon">Github</a></li>
                      <li><a href="https://qa.debian.org/developer.php?login=me%40emillon.org">Debian</a></li>
                      <li><a href="https://twitter.com/etiennemillon">Twitter</a></li>
                   </ul>
                </div>
        </div>
        <div class="maincontainer container">
          <div class="col-md-8 col-md-offset-2">
            <h1>The size of types</h1>

<p>by <em>Etienne Millon</em> on <strong>No date</strong></p>

<p>Tagged as: <a title="All pages tagged 'haskell'." href="../tags/haskell.html" rel="tag">haskell</a>.</p>

<p>“Modern” programming languages have a very useful feature : type inference.
It makes the compiler compute the type of all expressions and variables without
the programmer having to write them in the program.</p>
<p>As every algorithm, type inference has a cost : if it was too expensive, it would
be prohibitive to use. Its complexity is actually exponential, but linear in
practice. In this article I’ll present a classic case of exponential growth.</p>
<h1 id="a-size-operator">A size operator</h1>
<p>First, let’s define the size of a type. Intuitively, the size of a type is the
number of type constants and constructors it contains :</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">T0</span> <span class="ot">=</span> (<span class="dt">Int</span>, <span class="dt">Float</span> <span class="ot">-&gt;</span> () <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Float</span>))</span></code></pre></div>
<p>Here, we have 6 type constants and 4 type constructor applications<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, so size
of <code>t0</code> is 10.</p>
<p>Let’s define a typeclass to compute this information.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">Size</span> a <span class="kw">where</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ot">   tsize ::</span> a <span class="ot">-&gt;</span> <span class="dt">Int</span></span></code></pre></div>
<p>For base types (<code>Int</code>, <code>Float</code>, <code>()</code>, etc), the size is (arbitrarly) 1.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Size</span> <span class="dt">Int</span> <span class="kw">where</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>   tsize _ <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Size</span> <span class="dt">Float</span> <span class="kw">where</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>   tsize _ <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Size</span> () <span class="kw">where</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>   tsize _ <span class="ot">=</span> <span class="dv">1</span></span></code></pre></div>
<p>It is easy to extend <code>tsize</code> to tuples : the only thing to do is to add 1 to the
sum of size of all the arguments.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Size</span> a, <span class="dt">Size</span> b) <span class="ot">=&gt;</span> <span class="dt">Size</span> (a, b) <span class="kw">where</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  tsize (a, b) <span class="ot">=</span> <span class="dv">1</span> <span class="op">+</span> tsize a <span class="op">+</span> tsize b</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Size</span> a, <span class="dt">Size</span> b, <span class="dt">Size</span> c) <span class="ot">=&gt;</span> <span class="dt">Size</span> (a, b, c) <span class="kw">where</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  tsize (a, b, c) <span class="ot">=</span> <span class="dv">1</span> <span class="op">+</span> tsize a <span class="op">+</span> tsize b <span class="op">+</span> tsize c</span></code></pre></div>
<p>For <code>a -&gt; b</code>, it is trickier because we don’t have to our disposition a value of
type <code>a</code>. A solution is to add an “oracle” to the context of <code>tsize</code>, to that
the instance will have a type <code>(NonEmpty a, ...) =&gt; Size (a -&gt; b)</code>. Base types
are inhabited :</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">NonEmpty</span> a <span class="kw">where</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  some ::</span> a</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">NonEmpty</span> () <span class="kw">where</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  some <span class="ot">=</span> ()</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">NonEmpty</span> <span class="dt">Int</span> <span class="kw">where</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  some <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">NonEmpty</span> <span class="dt">Float</span> <span class="kw">where</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  some <span class="ot">=</span> <span class="dv">0</span></span></code></pre></div>
<p>Once again, the case of tuples is trivial.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">NonEmpty</span> a, <span class="dt">NonEmpty</span> b) <span class="ot">=&gt;</span> <span class="dt">NonEmpty</span> (a, b) <span class="kw">where</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  some <span class="ot">=</span> (some, some)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">NonEmpty</span> a, <span class="dt">NonEmpty</span> b, <span class="dt">NonEmpty</span> c) <span class="ot">=&gt;</span> <span class="dt">NonEmpty</span> (a, b, c) <span class="kw">where</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  some <span class="ot">=</span> (some, some, some)</span></code></pre></div>
<p>Building a function is easy : by ignoring the argument of type <code>a</code>, we can
create a function of type <code>a -&gt; b</code> provided that <code>b</code> is inhabited.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">NonEmpty</span> b <span class="ot">=&gt;</span> <span class="dt">NonEmpty</span> (a <span class="ot">-&gt;</span> b) <span class="kw">where</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  some <span class="ot">=</span> <span class="fu">const</span> some</span></code></pre></div>
<p>Finally, using this typeclass, we can write an instance for <code>Size (a -&gt; b)</code> :
“magically” find a inhabitant for <code>a</code>, apply <code>f</code> to it and we have enough
information to sum the sizes of their types.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">NonEmpty</span> a, <span class="dt">Size</span> a, <span class="dt">Size</span> b) <span class="ot">=&gt;</span> <span class="dt">Size</span> (a <span class="ot">-&gt;</span> b) <span class="kw">where</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>   tsize f <span class="ot">=</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>     <span class="kw">let</span> x <span class="ot">=</span> some <span class="kw">in</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>     <span class="dv">1</span> <span class="op">+</span> tsize x <span class="op">+</span> tsize (f x)</span></code></pre></div>
<p>Getting back to our example, we can verify that the size of <code>T0</code>…</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ot">t0 ::</span> <span class="dt">Int</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>t0 <span class="ot">=</span> tsize (<span class="ot">some ::</span> <span class="dt">T0</span>)</span></code></pre></div>
<p>…is indeed 10.</p>
<h1 id="an-exponential-combinator">An exponential combinator</h1>
<p>We present here a simple combinator that applies a value twice to a binary
function :</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ot">s ::</span> a <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> b</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>s x f <span class="ot">=</span> f x x</span></code></pre></div>
<p>For example, <code>s 2 (+) == 4</code>. But by parenthesizing differently its type, we can
have a different look at it :</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ot">s ::</span> a <span class="ot">-&gt;</span> ((a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> b)</span></code></pre></div>
<p>It transforms a type into another one with two occurrences :w</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>x0 x <span class="ot">= x ::</span> ()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>x1 x <span class="ot">=</span> s x0<span class="ot"> x ::</span> ()</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>x2 x <span class="ot">=</span> s x1<span class="ot"> x ::</span> ()</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>x3 x <span class="ot">=</span> s x2<span class="ot"> x ::</span> ()</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>x4 x <span class="ot">=</span> s x3<span class="ot"> x ::</span> ()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>x5 x <span class="ot">=</span> s x4<span class="ot"> x ::</span> ()</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>x6 x <span class="ot">=</span> s x5<span class="ot"> x ::</span> ()</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>x7 x <span class="ot">=</span> s x6<span class="ot"> x ::</span> ()</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>s0 <span class="ot">=</span> tsize x0</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>s1 <span class="ot">=</span> tsize x1</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>s2 <span class="ot">=</span> tsize x2</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>s3 <span class="ot">=</span> tsize x3</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>s4 <span class="ot">=</span> tsize x4</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>s5 <span class="ot">=</span> tsize x5</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>s6 <span class="ot">=</span> tsize x6</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>s7 <span class="ot">=</span> tsize x7</span></code></pre></div>
<p>a_n = 2^(n+1) - 3</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>s' x <span class="ot">=</span> (x, x)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>x0' <span class="ot">=</span> ()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>x1' <span class="ot">=</span> s' x0'</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>x2' <span class="ot">=</span> s' x1'</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>x3' <span class="ot">=</span> s' x2'</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>x4' <span class="ot">=</span> s' x3'</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>x5' <span class="ot">=</span> s' x4'</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>x6' <span class="ot">=</span> s' x5'</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>x7' <span class="ot">=</span> s' x6'</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>s0' <span class="ot">=</span> tsize x0'</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>s1' <span class="ot">=</span> tsize x1'</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>s2' <span class="ot">=</span> tsize x2'</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>s3' <span class="ot">=</span> tsize x3'</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>s4' <span class="ot">=</span> tsize x4'</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>s5' <span class="ot">=</span> tsize x5'</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>s6' <span class="ot">=</span> tsize x6'</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>s7' <span class="ot">=</span> tsize x7'</span></code></pre></div>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>Here we have counted <code>()</code> as a type constant, but it can be equivalently
seen as a 0-ary type constructor.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>



          </div>
        </div>
        <div class="footer container">
            <p>
                I love feedback! Feel free to catch me on twitter
                (<a href="https://twitter.com/etiennemillon">@etiennemillon</a>)
                or drop me mail (me AT emillon DOT org).
            </p>
        </div>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-51676253-1', 'emillon.org');
          ga('send', 'pageview');

        </script>
    </body>
</html>
