<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Enter the void * - The size of types</title>
        <link rel="stylesheet" type="text/css" href="../css/bootstrap.css" />
        <link rel="stylesheet" type="text/css" href="../css/extra.css" />
        <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
        <link rel="alternate" type="application/rss+xml" title="Enter the void *" href="../rss.xml" />
        <link rel="shortcut icon" href="../favicon.ico" />
        <link href="http://fonts.googleapis.com/css?family=Merriweather:400,300" rel="stylesheet" type="text/css" />
    </head>
    <body>
        <div class="header container">
            <h1 class="maintitle">Enter the void *</h1>
               <div class="nav-hdr">
                   <ul>
                      <li><a href="../">Home</a></li>
                      <li><a href="../posts.html">All posts</a></li>
                      <li><a href="../rss.xml">Feed</a></li>
                      <li><a href="https://github.com/emillon">Github</a></li>
                      <li><a href="https://qa.debian.org/developer.php?login=me%40emillon.org">Debian</a></li>
                      <li><a href="https://twitter.com/etiennemillon">Twitter</a></li>
                   </ul>
                </div>
        </div>
        <div class="maincontainer container">
          <div class="col-md-8 col-md-offset-2">
            <h1>The size of types</h1>

<p>by <em>Etienne Millon</em> on <strong>No date</strong></p>

<p>Tagged as: <a href="../tags/haskell.html">haskell</a>.</p>

<p>“Modern” programming languages have a very useful feature : type inference. It makes the compiler compute the type of all expressions and variables without the programmer having to write them in the program.</p>
<p>As every algorithm, type inference has a cost : if it was too expensive, it would be prohibitive to use. Its complexity is actually exponential, but linear in practice. In this article I’ll present a classic case of exponential growth.</p>
<h1 id="a-size-operator">A size operator</h1>
<p>First, let’s define the size of a type. Intuitively, the size of a type is the number of type constants and constructors it contains :</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">type</span> <span class="dt">T0</span> <span class="fu">=</span> (<span class="dt">Int</span>, <span class="dt">Float</span> <span class="ot">-&gt;</span> () <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>, <span class="dt">Float</span>))</a></code></pre></div>
<p>Here, we have 6 type constants and 4 type constructor applications<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>, so size of <code>t0</code> is 10.</p>
<p>Let’s define a typeclass to compute this information.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">class</span> <span class="dt">Size</span> a <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="ot">   tsize ::</span> a <span class="ot">-&gt;</span> <span class="dt">Int</span></a></code></pre></div>
<p>For base types (<code>Int</code>, <code>Float</code>, <code>()</code>, etc), the size is (arbitrarly) 1.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">instance</span> <span class="dt">Size</span> <span class="dt">Int</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-2" title="2">   tsize _ <span class="fu">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb3-3" title="3"></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw">instance</span> <span class="dt">Size</span> <span class="dt">Float</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-5" title="5">   tsize _ <span class="fu">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb3-6" title="6"></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="kw">instance</span> <span class="dt">Size</span> () <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-8" title="8">   tsize _ <span class="fu">=</span> <span class="dv">1</span></a></code></pre></div>
<p>It is easy to extend <code>tsize</code> to tuples : the only thing to do is to add 1 to the sum of size of all the arguments.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">instance</span> (<span class="dt">Size</span> a, <span class="dt">Size</span> b) <span class="ot">=&gt;</span> <span class="dt">Size</span> (a, b) <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-2" title="2">  tsize (a, b) <span class="fu">=</span> <span class="dv">1</span> <span class="fu">+</span> tsize a <span class="fu">+</span> tsize b</a>
<a class="sourceLine" id="cb4-3" title="3"></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">instance</span> (<span class="dt">Size</span> a, <span class="dt">Size</span> b, <span class="dt">Size</span> c) <span class="ot">=&gt;</span> <span class="dt">Size</span> (a, b, c) <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-5" title="5">  tsize (a, b, c) <span class="fu">=</span> <span class="dv">1</span> <span class="fu">+</span> tsize a <span class="fu">+</span> tsize b <span class="fu">+</span> tsize c</a></code></pre></div>
<p>For <code>a -&gt; b</code>, it is trickier because we don’t have to our disposition a value of type <code>a</code>. A solution is to add an “oracle” to the context of <code>tsize</code>, to that the instance will have a type <code>(NonEmpty a, ...) =&gt; Size (a -&gt; b)</code>. Base types are inhabited :</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">class</span> <span class="dt">NonEmpty</span> a <span class="kw">where</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="ot">  some ::</span> a</a>
<a class="sourceLine" id="cb5-3" title="3"></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="kw">instance</span> <span class="dt">NonEmpty</span> () <span class="kw">where</span></a>
<a class="sourceLine" id="cb5-5" title="5">  some <span class="fu">=</span> ()</a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="kw">instance</span> <span class="dt">NonEmpty</span> <span class="dt">Int</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb5-8" title="8">  some <span class="fu">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb5-9" title="9"></a>
<a class="sourceLine" id="cb5-10" title="10"><span class="kw">instance</span> <span class="dt">NonEmpty</span> <span class="dt">Float</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb5-11" title="11">  some <span class="fu">=</span> <span class="dv">0</span></a></code></pre></div>
<p>Once again, the case of tuples is trivial.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">instance</span> (<span class="dt">NonEmpty</span> a, <span class="dt">NonEmpty</span> b) <span class="ot">=&gt;</span> <span class="dt">NonEmpty</span> (a, b) <span class="kw">where</span></a>
<a class="sourceLine" id="cb6-2" title="2">  some <span class="fu">=</span> (some, some)</a>
<a class="sourceLine" id="cb6-3" title="3"></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="kw">instance</span> (<span class="dt">NonEmpty</span> a, <span class="dt">NonEmpty</span> b, <span class="dt">NonEmpty</span> c) <span class="ot">=&gt;</span> <span class="dt">NonEmpty</span> (a, b, c) <span class="kw">where</span></a>
<a class="sourceLine" id="cb6-5" title="5">  some <span class="fu">=</span> (some, some, some)</a></code></pre></div>
<p>Building a function is easy : by ignoring the argument of type <code>a</code>, we can create a function of type <code>a -&gt; b</code> provided that <code>b</code> is inhabited.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">instance</span> <span class="dt">NonEmpty</span> b <span class="ot">=&gt;</span> <span class="dt">NonEmpty</span> (a <span class="ot">-&gt;</span> b) <span class="kw">where</span></a>
<a class="sourceLine" id="cb7-2" title="2">  some <span class="fu">=</span> <span class="fu">const</span> some</a></code></pre></div>
<p>Finally, using this typeclass, we can write an instance for <code>Size (a -&gt; b)</code> : “magically” find a inhabitant for <code>a</code>, apply <code>f</code> to it and we have enough information to sum the sizes of their types.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">instance</span> (<span class="dt">NonEmpty</span> a, <span class="dt">Size</span> a, <span class="dt">Size</span> b) <span class="ot">=&gt;</span> <span class="dt">Size</span> (a <span class="ot">-&gt;</span> b) <span class="kw">where</span></a>
<a class="sourceLine" id="cb8-2" title="2">   tsize f <span class="fu">=</span></a>
<a class="sourceLine" id="cb8-3" title="3">     <span class="kw">let</span> x <span class="fu">=</span> some <span class="kw">in</span></a>
<a class="sourceLine" id="cb8-4" title="4">     <span class="dv">1</span> <span class="fu">+</span> tsize x <span class="fu">+</span> tsize (f x)</a></code></pre></div>
<p>Getting back to our example, we can verify that the size of <code>T0</code>…</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1"><span class="ot">t0 ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb9-2" title="2">t0 <span class="fu">=</span> tsize (<span class="ot">some ::</span> <span class="dt">T0</span>)</a></code></pre></div>
<p>…is indeed 10.</p>
<h1 id="an-exponential-combinator">An exponential combinator</h1>
<p>We present here a simple combinator that applies a value twice to a binary function :</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" title="1"><span class="ot">s ::</span> a <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> b</a>
<a class="sourceLine" id="cb10-2" title="2">s x f <span class="fu">=</span> f x x</a></code></pre></div>
<p>For example, <code>s 2 (+) == 4</code>. But by parenthesizing differently its type, we can have a different look at it :</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" title="1"><span class="ot">s ::</span> a <span class="ot">-&gt;</span> ((a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> b)</a></code></pre></div>
<p>It transforms a type into another one with two occurrences :w</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" title="1">x0 x <span class="fu">=</span><span class="ot"> x ::</span> ()</a>
<a class="sourceLine" id="cb12-2" title="2">x1 x <span class="fu">=</span> s x0<span class="ot"> x ::</span> ()</a>
<a class="sourceLine" id="cb12-3" title="3">x2 x <span class="fu">=</span> s x1<span class="ot"> x ::</span> ()</a>
<a class="sourceLine" id="cb12-4" title="4">x3 x <span class="fu">=</span> s x2<span class="ot"> x ::</span> ()</a>
<a class="sourceLine" id="cb12-5" title="5">x4 x <span class="fu">=</span> s x3<span class="ot"> x ::</span> ()</a>
<a class="sourceLine" id="cb12-6" title="6">x5 x <span class="fu">=</span> s x4<span class="ot"> x ::</span> ()</a>
<a class="sourceLine" id="cb12-7" title="7">x6 x <span class="fu">=</span> s x5<span class="ot"> x ::</span> ()</a>
<a class="sourceLine" id="cb12-8" title="8">x7 x <span class="fu">=</span> s x6<span class="ot"> x ::</span> ()</a></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" title="1">s0 <span class="fu">=</span> tsize x0</a>
<a class="sourceLine" id="cb13-2" title="2">s1 <span class="fu">=</span> tsize x1</a>
<a class="sourceLine" id="cb13-3" title="3">s2 <span class="fu">=</span> tsize x2</a>
<a class="sourceLine" id="cb13-4" title="4">s3 <span class="fu">=</span> tsize x3</a>
<a class="sourceLine" id="cb13-5" title="5">s4 <span class="fu">=</span> tsize x4</a>
<a class="sourceLine" id="cb13-6" title="6">s5 <span class="fu">=</span> tsize x5</a>
<a class="sourceLine" id="cb13-7" title="7">s6 <span class="fu">=</span> tsize x6</a>
<a class="sourceLine" id="cb13-8" title="8">s7 <span class="fu">=</span> tsize x7</a></code></pre></div>
<p>a_n = 2^(n+1) - 3</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" title="1">s' x <span class="fu">=</span> (x, x)</a>
<a class="sourceLine" id="cb14-2" title="2">x0' <span class="fu">=</span> ()</a>
<a class="sourceLine" id="cb14-3" title="3">x1' <span class="fu">=</span> s' x0'</a>
<a class="sourceLine" id="cb14-4" title="4">x2' <span class="fu">=</span> s' x1'</a>
<a class="sourceLine" id="cb14-5" title="5">x3' <span class="fu">=</span> s' x2'</a>
<a class="sourceLine" id="cb14-6" title="6">x4' <span class="fu">=</span> s' x3'</a>
<a class="sourceLine" id="cb14-7" title="7">x5' <span class="fu">=</span> s' x4'</a>
<a class="sourceLine" id="cb14-8" title="8">x6' <span class="fu">=</span> s' x5'</a>
<a class="sourceLine" id="cb14-9" title="9">x7' <span class="fu">=</span> s' x6'</a></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" title="1">s0' <span class="fu">=</span> tsize x0'</a>
<a class="sourceLine" id="cb15-2" title="2">s1' <span class="fu">=</span> tsize x1'</a>
<a class="sourceLine" id="cb15-3" title="3">s2' <span class="fu">=</span> tsize x2'</a>
<a class="sourceLine" id="cb15-4" title="4">s3' <span class="fu">=</span> tsize x3'</a>
<a class="sourceLine" id="cb15-5" title="5">s4' <span class="fu">=</span> tsize x4'</a>
<a class="sourceLine" id="cb15-6" title="6">s5' <span class="fu">=</span> tsize x5'</a>
<a class="sourceLine" id="cb15-7" title="7">s6' <span class="fu">=</span> tsize x6'</a>
<a class="sourceLine" id="cb15-8" title="8">s7' <span class="fu">=</span> tsize x7'</a></code></pre></div>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Here we have counted <code>()</code> as a type constant, but it can be equivalently seen as a 0-ary type constructor.<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</section>



          </div>
        </div>
        <div class="footer container">
            <p>
                I love feedback! Feel free to catch me on twitter
                (<a href="https://twitter.com/etiennemillon">@etiennemillon</a>)
                or drop me mail (me AT emillon DOT org).
            </p>
        </div>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-51676253-1', 'emillon.org');
          ga('send', 'pageview');

        </script>
    </body>
</html>
